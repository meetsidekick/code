<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidekick Lab</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dracula.min.css" rel="stylesheet" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: monospace; background: #000; color: #fff; overflow: hidden; }
        .gamescreen { width: 320px; height: 288px; margin: 20px auto; background: #8b956d; border: 8px solid #5a6b47; border-radius: 12px; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.3); }
        .screen { width: 288px; height: 224px; background: #9bbc0f; margin: 16px auto; border: 4px solid #1e2124; position: relative; font-size: 12px; }
        .dialog-box { position: absolute; bottom: 8px; left: 8px; right: 8px; background: #fff; color: #000; border: 2px solid #000; padding: 12px; min-height: 60px; cursor: pointer; }
        .dialog-text { line-height: 1.2; margin-bottom: 8px; }
        .dialog-arrow { position: absolute; bottom: 4px; right: 8px; animation: blink 1s infinite; }
        .character-sprite { position: absolute; top: 20px; left: 20px; width: 48px; height: 48px; image-rendering: pixelated; }
        .menu-options { position: absolute; bottom: 80px; left: 16px; right: 16px; }
        .menu-item { background: #fff; color: #000; border: 2px solid #000; padding: 8px 12px; margin-bottom: 4px; cursor: pointer; position: relative; }
        .menu-item:hover, .menu-item.selected { background: #000; color: #fff; }
        .input-field { background: #fff; color: #000; border: 2px solid #000; padding: 8px; width: 100%; font-family: monospace; font-size: 12px; margin: 8px 0; }
        .dashboard-grid { position: absolute; top: 100px; left: 16px; right: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .dashboard-card { background: #fff; color: #000; border: 2px solid #000; padding: 16px 8px; text-align: center; cursor: pointer; font-size: 10px; text-transform: uppercase; }
        .dashboard-card:hover { background: #000; color: #fff; }
        .dashboard-card.full-width { grid-column: span 2; }
        .app-list{position:absolute;top:80px;left:16px;right:16px;bottom:40px;overflow-y:auto;background:#fff;color:#000;border:2px solid #000;padding:8px}
        .app-item{padding:4px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;font-size:10px}
        .app-item:hover{background:#f0f0f0}
        .app-actions{display:flex;gap:4px}
        .mini-btn{padding:2px 6px;font-size:8px;background:#000;color:#fff;border:1px solid #000;cursor:pointer}
        .editor-screen{position:absolute;top:0;left:0;right:0;bottom:0;background:#9bbc0f;display:none}
        .editor-header{position:absolute;top:8px;left:8px;right:8px;background:#fff;color:#000;border:2px solid #000;padding:4px;font-size:10px;text-align:center}
        .codejar-editor { position: absolute; top: 40px; left: 8px; right: 8px; bottom: 40px; background: #282a36; color: #f8f8f2; border: 2px solid #000; font-family: monospace; font-size: 10px; resize: none; outline: none; overflow: auto; }
        .editor-buttons{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:4px}
        .editor-btn{flex:1;padding:8px;background:#fff;color:#000;border:2px solid #000;cursor:pointer;font-size:10px}
        .back-btn{position:absolute;top:8px;left:8px;background:#fff;color:#000;border:2px solid #000;padding:4px 8px;font-size:8px;cursor:pointer}
        .hidden { display: none !important; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="gamescreen">
        <div class="screen" id="game-screen">
            <div id="setup-screen">
                <div class="character-sprite" id="professor"><svg width="48" height="48" viewBox="0 0 48 48" style="image-rendering: pixelated;"><rect x="16" y="12" width="16" height="28" fill="#D4A574"/><rect x="16" y="8" width="16" height="4" fill="#2c1810"/><rect x="20" y="18" width="2" height="2" fill="#000"/><rect x="26" y="18" width="2" height="2" fill="#000"/><rect x="14" y="26" width="20" height="14" fill="#fff"/></svg></div>
                <div class="dialog-box" id="dialog-box"><div class="dialog-text" id="dialog-text"></div><div class="dialog-arrow" id="dialog-arrow">‚ñº</div></div>
                <div class="menu-options" id="menu-options" style="display: none;"></div>
            </div>
            <div id="dashboard-screen" class="hidden">
                <div class="dialog-box"><div class="dialog-text">Welcome back, <span id="trainer-name-display"></span>! <span id="sidekick-name-display"></span> is ready!</div></div>
                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="showEditScreen()">‚öôÔ∏è<br>Settings</div>
                    <div class="dashboard-card" onclick="resetDevice()">üîÑ<br>Reset</div>
                    <div class="dashboard-card full-width" onclick="showAppsScreen()">üì± Apps</div>
                </div>
            </div>
            <div id="edit-screen" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê BACK</button>
                <div class="dialog-box"><div class="dialog-text">Edit your settings:</div></div>
                <div style="position: absolute; top: 80px; left: 16px; right: 16px;">
                    <input type="text" class="input-field" id="edit-trainer-name" placeholder="Your Name">
                    <input type="text" class="input-field" id="edit-sidekick-name" placeholder="Sidekick Name">
                    <button class="menu-item" style="width:100%" onclick="saveSettings()">SAVE</button>
                </div>
            </div>
            <div id="apps-screen" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê BACK</button>
                <div class="dialog-box"><div class="dialog-text">Code Dashboard</div></div>
                <div style="position: absolute; top: 80px; left: 16px; right: 16px; display: flex; gap: 4px;"><button class="menu-item" style="flex: 1; font-size: 8px;" onclick="createNewApp()">+ NEW</button></div>
                <div class="app-list" id="app-list-container"></div>
            </div>
            <div class="editor-screen" id="editor-screen">
                <div class="editor-header" id="editor-title"></div>
                <div id="editor" class="codejar-editor"></div>
                <div class="editor-buttons">
                    <button id="save-btn" class="editor-btn" onclick="saveApp()">SAVE</button>
                    <button id="run-btn" class="editor-btn" onclick="runApp()">RUN</button>
                    <button class="editor-btn" onclick="closeEditor()">BACK</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/codejar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        let gameState = { trainerName: 'TRAINER', sidekickName: 'SIDEKICK' };
        const dialogs = ["Hello! Welcome to SIDEKICK!", "My name is OAK!", "First, what is your name?"];
        let currentDialog = 0, inputMode = false, menuMode = false, jar, dialogMode = false;

        function initEditor() { const editor = document.getElementById('editor'); const highlight = editor => { Prism.highlightElement(editor); }; jar = CodeJar(editor, highlight, { tab: '    ' }); }
        function showDialog(text, showArrow = true) { document.getElementById('dialog-text').textContent = text; document.getElementById('dialog-arrow').style.display = showArrow ? 'block' : 'none'; inputMode = false; menuMode = false; }
        function showMenu(items) { dialogMode = false; const menuDiv = document.getElementById('menu-options'); menuDiv.innerHTML = ''; menuDiv.style.display = 'block'; menuMode = true; items.forEach(item => { const menuItem = document.createElement('div'); menuItem.className = 'menu-item'; menuItem.innerHTML = item.text; menuItem.onclick = item.action; menuDiv.appendChild(menuItem); }); }
        function nextDialog() { currentDialog++; if (currentDialog < dialogs.length) { showDialog(dialogs[currentDialog]); if (currentDialog === 2) setTimeout(() => showNameInput(), 1000); } else { dialogMode = false; showConfirmation(); } }
        function showNameInput() { dialogMode = false; showDialog("Please enter your name:", false); const menuDiv = document.getElementById('menu-options'); menuDiv.innerHTML = `<input type="text" class="input-field" id="trainer-name-input" placeholder="Enter your name..." maxlength="10"><div class="menu-item" onclick="submitName()">OK</div>`; menuDiv.style.display = 'block'; inputMode = true; setTimeout(() => document.getElementById('trainer-name-input').focus(), 100); }
        function submitName() { gameState.trainerName = document.getElementById('trainer-name-input').value.trim().toUpperCase() || 'TRAINER'; document.getElementById('menu-options').style.display = 'none'; showDialog(`Right! So your name is ${gameState.trainerName}!`); setTimeout(() => { showDialog("Now, give your SIDEKICK a nickname?"); showMenu([{ text: "YES", action: showSidekickNaming }, { text: "NO", action: skipSidekickNaming }]); }, 2000); }
        function showSidekickNaming() { showDialog("What would you like to call it?", false); const menuDiv = document.getElementById('menu-options'); menuDiv.innerHTML = `<input type="text" class="input-field" id="sidekick-name-input" placeholder="Enter nickname..." maxlength="10"><div class="menu-item" onclick="submitSidekickName()">OK</div>`; menuDiv.style.display = 'block'; inputMode = true; setTimeout(() => document.getElementById('sidekick-name-input').focus(), 100); }
        function submitSidekickName() { gameState.sidekickName = document.getElementById('sidekick-name-input').value.trim().toUpperCase() || 'SIDEKICK'; showConfirmation(); }
        function skipSidekickNaming() { gameState.sidekickName = 'SIDEKICK'; showConfirmation(); }
        function showConfirmation() { showDialog(`You: ${gameState.trainerName}\nSidekick: ${gameState.sidekickName}\n\nIs this correct?`); showMenu([{ text: "YES", action: sendDataAndFinish }, { text: "NO", action: () => { currentDialog = 1; dialogMode = true; nextDialog(); } }]); }
        function sendDataAndFinish() { showDialog("Saving your settings...", false); fetch('/save', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `user_name=${encodeURIComponent(gameState.trainerName)}&sidekick_name=${encodeURIComponent(gameState.sidekickName)}` }).then(res => { if (res.ok) { showDialog("Reboot Device and Go to Settings(Menu Button) -> \"Start Dashboard\" and connect, and reload to continue.", false); } else { showDialog("Error: Could not save settings. Please reset the device.", false); } }); }
        function showDashboardScreen() { document.getElementById('setup-screen').style.display = 'none'; document.getElementById('dashboard-screen').classList.remove('hidden'); document.getElementById('trainer-name-display').textContent = gameState.trainerName; document.getElementById('sidekick-name-display').textContent = gameState.sidekickName; }
        function showDashboard() { document.getElementById('edit-screen').classList.add('hidden'); document.getElementById('apps-screen').classList.add('hidden'); document.getElementById('dashboard-screen').classList.remove('hidden'); }
        function showAppsScreen() { document.getElementById('dashboard-screen').classList.add('hidden'); document.getElementById('apps-screen').classList.remove('hidden'); renderApps(); }
        function renderApps() { const container = document.getElementById('app-list-container'); container.innerHTML = 'Loading...'; fetch('/api/apps').then(res => res.json()).then(apps => { container.innerHTML = ''; apps.forEach(app => { const appDiv = document.createElement('div'); appDiv.className = 'app-item'; let buttons = app.preserved ? `<button class="mini-btn" onclick="editApp('${app.name}', true)">VIEW</button>` : `<button class="mini-btn" onclick="editApp('${app.name}', false)">EDIT</button><button class="mini-btn danger" onclick="deleteApp('${app.name}')">DEL</button>`; appDiv.innerHTML = `<span>${app.name}</span><div class="app-actions">${buttons}</div>`; container.appendChild(appDiv); }); }); }
        function createNewApp() { const filename = prompt("Enter new app name:", "custom_code_new.py"); if (filename) { editApp(filename, false); } }
        function deleteApp(filename) { if (confirm(`Delete ${filename}?`)) { fetch(`/api/app/${filename}`, { method: 'DELETE' }).then(() => renderApps()); } }
        function editApp(filename, isReadOnly) { fetch(`/api/app/${filename}`).then(res => res.text()).then(code => { if (!jar) initEditor(); document.getElementById('editor-title').textContent = `Editing: ${filename}`; jar.updateCode(code || '# New File'); jar.readOnly(isReadOnly); document.getElementById('save-btn').style.display = isReadOnly ? 'none' : 'block'; document.getElementById('run-btn').style.display = isReadOnly ? 'none' : 'block'; document.getElementById('apps-screen').classList.add('hidden'); document.getElementById('editor-screen').style.display = 'block'; }); }
        function saveApp() { const filename = document.getElementById('editor-title').textContent.replace('Editing: ', ''); const code = jar.toString(); fetch('/api/apps', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: filename, code: code }) }).then(res => { if (res.ok) closeEditor(); else alert("Failed to save app."); }); }
        function closeEditor() { document.getElementById('editor-screen').style.display = 'none'; showAppsScreen(); }

        function saveSettings() {
            gameState.trainerName = document.getElementById('edit-trainer-name').value.trim().toUpperCase() || 'TRAINER';
            gameState.sidekickName = document.getElementById('edit-sidekick-name').value.trim().toUpperCase() || 'SIDEKICK';
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_name: gameState.trainerName, sidekick_name: gameState.sidekickName })
            }).then(res => {
                if (res.ok) {
                    showDashboard();
                } else {
                    alert("Failed to save settings.");
                }
            });
        }

        function resetDevice() {
            if (confirm('Reset SIDEKICK? All data will be lost!')) {
                fetch('/api/reset', { method: 'POST' }).then(res => {
                    if (res.ok) {
                        // Device will reboot
                    } else {
                        alert("Failed to reset device.");
                    }
                });
            }
        }
        document.addEventListener('DOMContentLoaded', () => { fetch('/api/status').then(res => res.json()).then(status => { gameState.trainerName = status.user_name; gameState.sidekickName = status.sidekick_name; if (status.setup_completed) { showDashboardScreen(); } else { document.getElementById('dialog-box').addEventListener('click', () => { if(dialogMode) nextDialog(); }); dialogMode = true; showDialog(dialogs[0]); } }); });
    </script>
</body>
</html>